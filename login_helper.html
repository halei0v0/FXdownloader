<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç•ªèŒ„å°è¯´ç™»å½•åŠ©æ‰‹</title>
    <style>
        body {
            font-family: 'Microsoft YaHei UI', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .status {
            color: #666;
            margin: 20px 0;
            font-size: 16px;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        iframe {
            width: 100%;
            height: 500px;
            border: none;
            border-radius: 10px;
            margin-top: 20px;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
        }
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        .btn-success {
            background: #00B894;
        }
        .btn-success:hover {
            background: #00A383;
        }
        #cookieDisplay {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“š ç•ªèŒ„å°è¯´ç™»å½•åŠ©æ‰‹</h1>
        <div id="status" class="status">
            <span class="loading"></span>æ­£åœ¨å‡†å¤‡ç™»å½•é¡µé¢...
        </div>
        <div id="buttons" style="display: none;">
            <button class="btn btn-success" onclick="openLoginWindow()">æ‰“å¼€ç™»å½•çª—å£</button>
        </div>
        <div id="cookieDisplay"></div>
    </div>

    <script>
        const LOGIN_URL = 'https://fanqienovel.com/main/writer/login';
        let loginWindow = null;
        let checkInterval = null;

        // é¡µé¢åŠ è½½å®Œæˆå
        window.onload = function() {
            document.getElementById('status').innerHTML = 'ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰“å¼€ç•ªèŒ„å°è¯´ç™»å½•é¡µé¢';
            document.getElementById('buttons').style.display = 'block';
        };

        function openLoginWindow() {
            document.getElementById('status').innerHTML = '<span class="loading"></span>æ­£åœ¨æ‰“å¼€ç™»å½•çª—å£ï¼Œè¯·åœ¨å¼¹å‡ºçš„çª—å£ä¸­å®Œæˆç™»å½•...';
            
            // æ‰“å¼€ç•ªèŒ„å°è¯´ç™»å½•é¡µé¢
            loginWindow = window.open(LOGIN_URL, 'fanqie_login', 'width=800,height=600');
            
            if (loginWindow) {
                // å¼€å§‹è½®è¯¢æ£€æŸ¥ç™»å½•çŠ¶æ€
                checkInterval = setInterval(checkLoginStatus, 1000);
            } else {
                document.getElementById('status').innerHTML = 'âŒ æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®';
            }
        }

        function checkLoginStatus() {
            if (!loginWindow || loginWindow.closed) {
                clearInterval(checkInterval);
                document.getElementById('status').innerHTML = 'âŒ ç™»å½•çª—å£å·²å…³é—­ï¼Œè¯·é‡è¯•';
                return;
            }

            try {
                // å°è¯•è®¿é—®ç™»å½•çª—å£çš„cookie
                const cookies = loginWindow.document.cookie;
                
                if (cookies && (cookies.includes('sessionid') || cookies.includes('passport_csrf_token'))) {
                    // æ£€æµ‹åˆ°ç™»å½•æˆåŠŸçš„cookie
                    clearInterval(checkInterval);
                    handleLoginSuccess(cookies);
                }
            } catch (e) {
                // è·¨åŸŸé™åˆ¶ï¼Œæ— æ³•ç›´æ¥è®¿é—®cookie
                // ä½¿ç”¨postMessageé€šä¿¡
            }
        }

        // ç›‘å¬æ¥è‡ªç™»å½•çª—å£çš„æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'cookie') {
                clearInterval(checkInterval);
                handleLoginSuccess(event.data.cookie);
            }
        });

        function handleLoginSuccess(cookies) {
            document.getElementById('status').innerHTML = 'âœ… æ£€æµ‹åˆ°ç™»å½•æˆåŠŸï¼æ­£åœ¨è·å–Cookie...';
            
            // æå–å¹¶æ˜¾ç¤ºcookie
            const cookieObj = {};
            cookies.split(';').forEach(cookie => {
                const [name, value] = cookie.trim().split('=');
                if (name && value) {
                    cookieObj[name] = value;
                }
            });

            // æ˜¾ç¤ºcookie
            const displayDiv = document.getElementById('cookieDisplay');
            displayDiv.style.display = 'block';
            displayDiv.textContent = 'å·²è·å–åˆ°ä»¥ä¸‹Cookie:\n' + JSON.stringify(cookieObj, null, 2);

            // å°†cookieå‘é€å›ä¸»åº”ç”¨
            if (window.opener) {
                window.opener.postMessage({
                    type: 'fanqie_cookies',
                    cookies: cookieObj
                }, '*');
            }

            // åŒæ—¶ä¹Ÿå°è¯•é€šè¿‡HTTPå‘é€ï¼ˆå¦‚æœæœ‰æœåŠ¡å™¨ï¼‰
            fetch('/save_cookies', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ cookies: cookieObj })
            }).then(() => {
                document.getElementById('status').innerHTML = 'âœ… Cookieå·²ä¿å­˜ï¼<br><br>æ‚¨å¯ä»¥å…³é—­æ­¤é¡µé¢äº†ã€‚';
                setTimeout(() => {
                    if (loginWindow) {
                        loginWindow.close();
                    }
                }, 2000);
            }).catch(err => {
                console.log('HTTPä¿å­˜å¤±è´¥ï¼Œä½†Cookieå·²è·å–:', err);
                document.getElementById('status').innerHTML = 'âœ… Cookieå·²è·å–ï¼<br>è¯·å¤åˆ¶ä¸Šæ–¹Cookieåˆ°è½¯ä»¶ä¸­ä½¿ç”¨ã€‚<br><br>æ‚¨å¯ä»¥å…³é—­æ­¤é¡µé¢äº†ã€‚';
            });
        }

        // å¦‚æœé¡µé¢æ˜¯é€šè¿‡iframeåµŒå…¥çš„
        if (window.self !== window.top) {
            // åœ¨iframeä¸­
            document.body.innerHTML = '';
        }
    </script>
</body>
</html>